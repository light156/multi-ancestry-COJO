name: Linux binary compatibility test

on:
  push:
  pull_request:

jobs:
  ubuntu:
    name: Ubuntu 22.04 (host runner)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Inspect binary
        run: |
          file ./manc_cojo
          ldd ./manc_cojo || true

      - name: Run binary
        run: ./manc_cojo --help
  
  containers:
    name: Container runtime tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image:
          - debian:bookworm
          - fedora:latest
          - almalinux:9
          - alpine:latest

    container:
      image: ${{ matrix.image }}

    steps:
      - uses: actions/checkout@v4

      - name: Install runtime tools
        run: |
          if command -v apt-get >/dev/null; then
            apt-get update
            apt-get install -y file ca-certificates
          elif command -v dnf >/dev/null; then
            dnf install -y file ca-certificates
          elif command -v apk >/dev/null; then
            apk add --no-cache file ca-certificates
          fi

      - name: Inspect binary
        run: |
          file ./manc_cojo
          ldd ./manc_cojo || true

      - name: Run binary
        run: ./manc_cojo --help

  build_and_test:
    name: Build + unit tests
    runs-on: ubuntu-latest
    container:
      image: gcc:13
    steps:
      - uses: actions/checkout@v4

      - name: Run tests
        run: |
          chmod +x test/run_tests.sh
          bash test/run_tests.sh